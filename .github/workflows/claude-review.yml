name: Claude Code Review

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  review:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: write
      id-token: write
    env:
      HAS_MAX_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN != '' && 'true' || 'false' }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 1

      # Primary: Use Max subscription (no additional cost)
      - name: Review with Max subscription
        id: max
        if: env.HAS_MAX_TOKEN == 'true'
        continue-on-error: true
        uses: anthropics/claude-code-action@v1
        with:
          allowed_bots: "claude"
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt: |
            Review this pull request and validate it against the approved plan.

            CRITICAL CONTEXT PRESERVATION:
            1. First, read the PR description to get the approved implementation plan:
               gh pr view ${{ github.event.pull_request.number }} --json body --jq '.body'

            2. Validate that the code changes implement this plan correctly:
               - Does the PR implement all planned features?
               - Are there features NOT in the plan? (scope creep)
               - Does the implementation approach match the plan?

            3. Also check standard code quality:
               - Bugs, convention violations, missing tests
               - Security issues, performance concerns

            4. Use `gh pr diff` to read the changes

            5. Post your review using `gh pr review` with --comment flag

            Format your review body:
            - If issues found: start with "## Issues Found" then list each issue
            - If code is clean: start with "## No Issues" then brief confirmation
            - Always reference plan when validating features

            One sentence per issue with the fix. Skip praise.
          claude_args: "--max-turns 5 --dangerously-skip-permissions"

      # Check if fallback is actually needed (avoid double-charging on max-turns)
      - name: Check if fallback needed
        id: check_fallback
        if: steps.max.outcome != 'success'
        run: |
          OUTPUT="/home/runner/work/_temp/claude-execution-output.json"
          if [ -f "$OUTPUT" ] && grep -q "error_max_turns" "$OUTPUT" 2>/dev/null; then
            echo "Max hit turn limit after doing work — skipping fallback"
            echo "needed=false" >> $GITHUB_OUTPUT
          else
            echo "needed=true" >> $GITHUB_OUTPUT
          fi

      # Fallback: Use API key (pay-per-token) — only on auth failures, not max-turns
      - name: Fallback to API key
        id: fallback
        if: steps.max.outcome != 'success' && steps.check_fallback.outputs.needed != 'false'
        uses: anthropics/claude-code-action@v1
        with:
          allowed_bots: "claude"
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          prompt: |
            Review this pull request and validate it against the approved plan.

            CRITICAL CONTEXT PRESERVATION:
            1. First, read the PR description to get the approved implementation plan:
               gh pr view ${{ github.event.pull_request.number }} --json body --jq '.body'

            2. Validate that the code changes implement this plan correctly:
               - Does the PR implement all planned features?
               - Are there features NOT in the plan? (scope creep)
               - Does the implementation approach match the plan?

            3. Also check standard code quality:
               - Bugs, convention violations, missing tests
               - Security issues, performance concerns

            4. Use `gh pr diff` to read the changes

            5. Post your review using `gh pr review` with --comment flag

            Format your review body:
            - If issues found: start with "## Issues Found" then list each issue
            - If code is clean: start with "## No Issues" then brief confirmation
            - Always reference plan when validating features

            One sentence per issue with the fix. Skip praise.
          claude_args: "--max-turns 5 --dangerously-skip-permissions"

      # Request fixes for review findings
      - name: Request fixes for review findings
        if: always()
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN }}
        run: |
          PR_NUM=${{ github.event.pull_request.number }}

          # Check if review found issues
          REVIEW=$(gh pr view "$PR_NUM" --json reviews --jq '.reviews[-1].body')
          if ! echo "$REVIEW" | grep -q "## Issues Found"; then
            echo "No issues found in review - skipping auto-fix"
            exit 0
          fi

          # Count existing fix cycles
          MARKER_COUNT=$(gh api "repos/$GITHUB_REPOSITORY/issues/$PR_NUM/comments" \
            --jq '.[].body' | grep -c '<!-- review-fix-cycle -->' || echo "0")

          if [ "$MARKER_COUNT" -ge 2 ]; then
            echo "⚠️ Auto-fix cycle limit reached (2 iterations)"

            # Post human notification
            gh pr comment "$PR_NUM" --body "⚠️ **Auto-fix Cycle Limit Reached**

          The automated review-fix cycle has completed 2 iterations but issues remain. This PR now requires human review and manual fixes.

          **What happened:**
          - Initial code review found issues
          - Auto-fix attempt #1 completed
          - Auto-fix attempt #2 completed
          - Issues still remain after 2 fix attempts

          **Next steps:**
          1. Review the code review feedback above
          2. Apply fixes manually or provide specific guidance to @claude
          3. Push your changes to continue

          cc: @${{ github.event.pull_request.user.login }}"

            # Add label to indicate human intervention needed
            gh pr edit "$PR_NUM" --add-label needs-human-review --remove-label auto-merge

            exit 0
          fi

          # Post auto-fix request
          gh pr comment "$PR_NUM" --body "@claude Please fix the issues identified in the code review above.

          <!-- review-fix-cycle -->
          <!-- Cycle count: $((MARKER_COUNT + 1)) -->"
