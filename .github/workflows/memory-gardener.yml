name: Memory Gardener

on:
  schedule:
    # Every Sunday at midnight UTC
    - cron: "0 0 * * 0"
  workflow_dispatch:

jobs:
  garden-memory:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    env:
      HAS_MAX_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN != '' && 'true' || 'false' }}
      MEMORY_GARDENER_PROMPT: |
        # ROLE
        You are the Memory Gardener. You maintain the project knowledge base at docs/agent-learnings.md by pruning stale, duplicate, and low-value entries, and consolidating related ones.

        # YOUR PROCESS
        1. Read the full learnings file: `cat docs/agent-learnings.md`
        2. Read CLAUDE.md to check for overlapping content: `cat CLAUDE.md 2>/dev/null || echo 'No CLAUDE.md'`
        3. Analyse the entries and identify:
           - **Duplicates**: Same learning recorded multiple times (keep the clearest version)
           - **Superseded**: Entries invalidated by later PRs (e.g., a gotcha that was fixed)
           - **Redundant with CLAUDE.md**: Learning already captured as a permanent convention
           - **Too vague to act on**: Entries so generic they provide no value
           - **Consolidatable**: 3+ closely related entries that can be merged into one richer entry
        4. Decide: are there improvements worth making?
           - If the file is already clean and under 100 entries: exit without changes
           - If improvements exist: proceed to step 5
        5. Create a branch and write the cleaned file:
           ```bash
           git config user.name "github-actions[bot]"
           git config user.email "github-actions[bot]@users.noreply.github.com"
           git checkout -b chore/memory-gardener-$(date +%Y%m%d)
           ```
        6. Rewrite docs/agent-learnings.md with only the high-value entries, preserving the header/format block
        7. Commit, push, and open a PR:
           ```bash
           git add docs/agent-learnings.md
           git commit -m "chore: prune and consolidate agent learnings"
           git push origin chore/memory-gardener-$(date +%Y%m%d)
           gh pr create \
             --title "chore: memory gardener â€” prune agent learnings" \
             --body "## Summary
           Weekly memory gardener run. Changes made:
           - Removed N duplicate entries
           - Removed N superseded entries
           - Consolidated N related entries
           - Removed N entries now in CLAUDE.md

           Review the diff to confirm no valuable learnings were lost before merging.

           ðŸ¤– Generated by Memory Gardener" \
             --label "memory-gardener"
           ```

        # CONSTRAINTS
        - Preserve the header block at the top of the file unchanged
        - When in doubt about an entry's value, KEEP it â€” false positives are worse than noise
        - Never remove the most recent entry (last 30 days) â€” it may still be relevant
        - If you removed entries, briefly note what was removed and why in the PR body
        - Only create a PR if you actually changed the file (no empty PRs)
        - 20 turn limit

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          token: ${{ secrets.PAT_TOKEN }}

      - name: Ensure memory-gardener label exists
        run: |
          gh label create "memory-gardener" --color "6B7280" --description "PR from Memory Gardener workflow" --force || true
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN }}

      - name: Check if learnings file has content worth gardening
        id: check
        run: |
          if [ ! -f docs/agent-learnings.md ]; then
            echo "skip=true" >> $GITHUB_OUTPUT
            echo "No learnings file found â€” skipping"
            exit 0
          fi
          # Count entries (lines starting with ###)
          ENTRY_COUNT=$(grep -c "^### \[" docs/agent-learnings.md 2>/dev/null || echo "0")
          echo "Found $ENTRY_COUNT entries"
          if [ "$ENTRY_COUNT" -lt 5 ]; then
            echo "skip=true" >> $GITHUB_OUTPUT
            echo "Fewer than 5 entries â€” nothing to garden yet"
          else
            echo "skip=false" >> $GITHUB_OUTPUT
          fi

      # Run Memory Gardener (Sonnet â€” needs judgment for consolidation decisions)
      - name: Run Memory Gardener
        id: gardener_max
        if: steps.check.outputs.skip != 'true' && env.HAS_MAX_TOKEN == 'true'
        continue-on-error: true
        uses: anthropics/claude-code-action@v1
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN }}
        with:
          display_report: "false"
          prompt: "Review and prune docs/agent-learnings.md in repository ${{ github.repository }}. Create a PR with the cleaned version if improvements are needed."
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          github_token: ${{ secrets.PAT_TOKEN }}
          claude_args: >-
            --model claude-sonnet-4-6
            --max-turns 20
            --allowedTools "Read,Write,Bash(git *),Bash(gh pr *),Bash(gh label *),Bash(cat *),Bash(grep *),Bash(date *)"
            --append-system-prompt "${{ env.MEMORY_GARDENER_PROMPT }}"

      - name: Run Memory Gardener (Fallback)
        if: steps.check.outputs.skip != 'true' && (env.HAS_MAX_TOKEN != 'true' || steps.gardener_max.outcome != 'success')
        uses: anthropics/claude-code-action@v1
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN }}
        with:
          display_report: "false"
          prompt: "Review and prune docs/agent-learnings.md in repository ${{ github.repository }}. Create a PR with the cleaned version if improvements are needed."
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          github_token: ${{ secrets.PAT_TOKEN }}
          claude_args: >-
            --model claude-sonnet-4-6
            --max-turns 20
            --allowedTools "Read,Write,Bash(git *),Bash(gh pr *),Bash(gh label *),Bash(cat *),Bash(grep *),Bash(date *)"
            --append-system-prompt "${{ env.MEMORY_GARDENER_PROMPT }}"
